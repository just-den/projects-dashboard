<template>
	<main
		:style="main_block_styles"
		>
		 <div class="title">
			<h4>   	
				   finance
			</h4>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                <rect x="48" y="144" width="416" height="288" rx="48" ry="48" fill="none" stroke="#00897b" stroke-linejoin="round" stroke-width="32"/>
                <path d="M411.36 144v-30A50 50 0 00352 64.9L88.64 109.85A50 50 0 0048 159v49" fill="none" stroke="#00897b" stroke-linejoin="round" stroke-width="32"/>
                <path d="M368 320a32 32 0 1132-32 32 32 0 01-32 32z"/>
            </svg>
         </div>	
         <section class="finance">
             <div class="total">
                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 325.603 325.603">
                        <path d="M325.556 173.989c-1.013-17.711-32.962-25.66-64.652-25.66-10.755 0-21.536.919-31.131 2.82V48.208c0-.292-.018-.579-.048-.862-1.014-17.712-32.961-25.66-64.651-25.66-31.69 0-63.638 7.948-64.651 25.66-.03.283-.048.57-.048.862v69.76c-10.661-2.58-23.185-3.821-35.676-3.821-31.69 0-63.638 7.948-64.65 25.659a7.89 7.89 0 00-.049.862v136.729c0 18.321 32.496 26.522 64.701 26.522 32.204 0 64.698-8.201 64.698-26.522v-1.393c10.664 2.578 23.187 3.817 35.675 3.817 10.754 0 21.533-.92 31.131-2.82v.396c0 18.321 32.495 26.522 64.699 26.522s64.699-8.201 64.699-26.522V174.851c0-.292-.017-.579-.047-.862zm-95.783-6.452c7.811-1.835 18.188-3.208 31.131-3.208 29.235 0 45.4 7.001 48.412 10.522-3.013 3.521-19.177 10.523-48.411 10.523-12.943 0-23.319-1.373-31.132-3.209-8.093-1.901-13.43-4.297-16-6.18-.553-.405-.983-.787-1.279-1.134.297-.347.727-.729 1.279-1.134 2.57-1.883 7.907-4.279 16-6.18zm-64.7-129.852c29.234 0 45.398 7.001 48.411 10.522-3.013 3.521-19.177 10.522-48.41 10.522-29.234 0-45.399-7.001-48.412-10.522 3.013-3.521 19.177-10.522 48.411-10.522zM116.374 66.64c12.462 5.506 30.626 8.09 48.7 8.09s36.237-2.584 48.698-8.09v15.358c-2.074 3.361-18.337 10.913-48.698 10.913-30.362 0-46.626-7.552-48.7-10.913V66.64zm0 34.182c12.462 5.506 30.626 8.09 48.7 8.09s36.237-2.584 48.698-8.09v15.359c-2.074 3.361-18.337 10.911-48.698 10.911-30.362 0-46.626-7.55-48.7-10.911v-15.359zm-51.676 29.324c15.636 0 27.53 2.003 35.676 4.405 7.085 2.088 11.336 4.479 12.737 6.116-1.401 1.638-5.652 4.029-12.737 6.118-8.146 2.401-20.038 4.404-35.673 4.404-29.236 0-45.401-7.001-48.413-10.522 3.013-3.52 19.177-10.521 48.41-10.521zM16 159.1c12.462 5.506 30.626 8.09 48.701 8.09 12.485 0 25.012-1.234 35.673-3.813 4.772-1.153 9.173-2.575 13.025-4.277v15.36c-1.006 1.63-5.358 4.244-13.025 6.506-8.146 2.402-20.033 4.407-35.673 4.407-30.363 0-46.627-7.552-48.701-10.913V159.1zm0 34.184c12.462 5.506 30.626 8.09 48.701 8.09 12.485 0 25.012-1.234 35.673-3.813 4.772-1.153 9.173-2.575 13.025-4.277v15.357c-1.006 1.63-5.358 4.244-13.025 6.506-8.146 2.402-20.033 4.407-35.673 4.407-30.363 0-46.627-7.552-48.701-10.913v-15.357zm0 34.18c12.462 5.506 30.626 8.09 48.701 8.09 12.485 0 25.012-1.234 35.673-3.813 4.772-1.153 9.173-2.575 13.025-4.277v15.359c-1.005 1.631-5.357 4.244-13.025 6.506-8.146 2.402-20.033 4.407-35.673 4.407-30.364 0-46.628-7.551-48.701-10.913v-15.359zm97.399 49.543c-2.083 3.363-18.347 10.911-48.698 10.911-30.354 0-46.618-7.548-48.701-10.911v-15.36c12.462 5.506 30.626 8.09 48.701 8.09 14.496 0 29.041-1.667 40.664-5.165 2.869-.864 5.566-1.835 8.034-2.925v15.36zm82.806-16.397c-7.813 1.836-18.186 3.211-31.131 3.211-15.64 0-27.528-2.005-35.675-4.408v-17.585c10.662 2.578 23.189 3.813 35.675 3.813 10.756 0 21.533-.923 31.131-2.824v17.793zm0-34.18c-7.813 1.835-18.186 3.21-31.131 3.21-15.641 0-27.529-2.005-35.675-4.407v-17.589c10.662 2.578 23.189 3.813 35.675 3.813 10.756 0 21.533-.923 31.131-2.824v17.797zm0-51.579v17.396c-7.813 1.836-18.186 3.21-31.131 3.21-15.641 0-27.529-2.005-35.675-4.407v-17.586c10.662 2.578 23.189 3.813 35.675 3.813 10.764 0 21.55-.925 31.153-2.829-.006.134-.022.266-.022.403zm-31.131-13.575c-15.641 0-27.529-2.005-35.675-4.407v-16.201c0-.292-.018-.579-.048-.862-.011-.188-.045-.368-.063-.554 10.687 2.597 23.256 3.841 35.785 3.841 18.074 0 36.237-2.584 48.698-8.089v15.359c-2.073 3.361-18.335 10.913-48.697 10.913zm144.529 115.731c-2.083 3.363-18.347 10.911-48.699 10.911s-46.617-7.548-48.699-10.91v-15.361c3.452 1.525 7.354 2.818 11.557 3.902 10.973 2.829 24.075 4.188 37.143 4.188 18.074 0 36.238-2.584 48.699-8.09v15.36zm0-34.183c-2.073 3.362-18.337 10.913-48.699 10.913-12.946 0-23.319-1.374-31.132-3.21-8.094-1.901-13.432-4.297-16-6.18-.767-.563-1.294-1.08-1.567-1.523v-15.359c5.046 2.229 11.036 3.972 17.567 5.266 9.599 1.901 20.376 2.824 31.132 2.824 18.074 0 36.238-2.584 48.699-8.09v15.359zm0-34.183c-2.074 3.361-18.338 10.913-48.699 10.913-12.946 0-23.319-1.375-31.132-3.21-8.094-1.902-13.432-4.298-16-6.181-.767-.561-1.294-1.079-1.567-1.522v-15.357c5.046 2.229 11.036 3.972 17.567 5.266 9.599 1.901 20.376 2.824 31.132 2.824 18.074 0 36.238-2.584 48.699-8.09v15.357z"/>
                    </svg>
                 <div class="ycb">
                     <div 
                        v-if="current.usd.active"
                        class="usd"
                    >
                         <span v-text="current.usd.sign"></span>
                         <span v-text="current.usd.yearSum"></span>
                    </div>
                    <div 
                        class="eur"
                        v-if="current.eur.active"
                    >
                        <span v-text="current.eur.sign"></span>
                        <span v-text="current.eur.yearSum"></span>
                    </div>
                </div>
             </div>
             <div class="data">
                 <div class="tabs">
                     <button 
                        v-for="year in years"
                        :class="{ 'active': year.active, 'disabled': disabled.getYear }"
                        @click.prevent = "getMonthsData(year.name)"
                     >
                        <svg 
                            v-if="year.active"
                            xmlns="http://www.w3.org/2000/svg" 
                            viewBox="0 0 512 512"
                        >
                            <path d="M96 448l320-192L96 64v384z"/>
                        </svg>
                        <span v-text="year.name"></span>
                     </button>                   
                 </div>
                 <div class="chart">
                    <div class="legend">
                        <label 
                            class="eur"
                            :class="{ 'active': currencyChecked.eur }"
                        >
                            <input 
                                type="checkbox"
                                :checked="currencyChecked.eur" 
                                @change="recountAndShow($event.target.checked,'eur','€')"
                            >
                            <span>
                                <div class="mark"></div>
                            </span>                           
                            <span>eur</span>
                        </label>
                        <label 
                            class="usd"
                            :class="{ 'active': currencyChecked.usd }"
                        >
                            <input 
                                type="checkbox"
                                :checked="currencyChecked.usd" 
                                @change="recountAndShow($event.target.checked,'usd','$')"
                            >
                            <span>
                                <div class="mark"></div>
                            </span>
                            <span>usd</span>
                        </label>
                    </div>
                    <div class="body">
                        <div 
                            class="month"
                            v-for="month in sumByMonth"
                        >
                            <div 
                                class="label"
                                v-text="month.name"
                            ></div>
                            <div class="lines">
                                <div 
                                    class="eur"
                                    v-if="month.eur.active"
                                >
                                    <div 
                                        class="line"
                                        :style="{height: month.eur.height + '%'}"
                                    ></div>
                                    <div 
                                        class="mark" 
                                        v-if="month.eur.height"
                                        v-text="month.eur.label"
                                        :style="{bottom: month.eur.height + 3 + '%' }"
                                    ></div>
                                </div>
                                <div 
                                    class="usd"
                                    v-if="month.usd.active"
                                >
                                    <div 
                                        class="line"
                                        :style="{height: month.usd.height + '%'}"
                                    ></div>
                                    <div 
                                        class="mark" 
                                        v-if="month.usd.height"
                                        v-text="month.usd.label"
                                        :style="{bottom: month.usd.height + 3 + '%' }"
                                    ></div>
                                </div>
                            </div>

                        </div>
                    </div>
                 </div>
             </div>
             <div class="payments">
                 <h4>recieved payments</h4>
                 <div 
                    class="inb"
                    ref="add_payment"
                >
                    <div class="inb1">
                        <input 
                            type="text" 
                            placeholder="add new"
                            :value="formAddPayment.amount"
                            @input="formAddPayment.change($event.target.value)"
                        >
                        <a 
                            href="#"
                            v-if="formAddPayment.button"
                            class="add"
                            :class="{'disabled': disabled.addPayment}"
                            @click.prevent="addPayment()"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="32" d="M416 128L192 384l-96-96"/>
                            </svg>
                        </a>
                        <div class="currency">
                            <select
                                v-model="formAddPayment.currency"
                            >
                                <option value="usd-$">$</option>
                                <option value="eur-€">€</option>
                            </select>
                        </div>
                    </div>
                     <div class="calendar">
                         <div class="flatpickr">
                                <input type="text" data-input v-model="formAddPayment.date">      
                                <a href="javascript:void(0)" data-toggle>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                                        <rect x="48" y="80" width="416" height="384" rx="48" ry="48" fill="none" stroke="#000" stroke-linejoin="round" stroke-width="32"/>
                                        <path d="M397.82 80H114.18C77.69 80 48 110.15 48 147.2V208h16c0-16 16-32 32-32h320c16 0 32 16 32 32h16v-60.8c0-37.05-29.69-67.2-66.18-67.2z"/>
                                        <circle cx="296" cy="232" r="24"/>
                                        <circle cx="376" cy="232" r="24"/>
                                        <circle cx="296" cy="312" r="24"/>
                                        <circle cx="376" cy="312" r="24"/>
                                        <circle cx="136" cy="312" r="24"/>
                                        <circle cx="216" cy="312" r="24"/>
                                        <circle cx="136" cy="392" r="24"/>
                                        <circle cx="216" cy="392" r="24"/>
                                        <circle cx="296" cy="392" r="24"/>
                                        <path fill="none" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="32" d="M128 48v32M384 48v32"/>
                                    </svg>
                                </a>
                            </div>
                            <span v-text="formAddPayment.date"></span>
                     </div>
                 </div>
                 <div class="slb">
                     <div class="slct">
                        <div>choose</div>
                        <select
                            @change="getPaymentsByYear($event.target.value)"                           
                        >
                            <option 
                                v-for="year in years"
                                :value="year.name"
                                v-text="year.name"
                            ></option>
                        </select>
                     </div>
                     <div class="payment_notes">
                         <ul>
                             <li
                                v-for="payment in paymentsList">
                                 <div class="spbl">
                                    <span 
                                        v-text="payment.sign"
                                        v-if="!payment.edit"
                                    ></span>
                                    <select
                                        v-model="formEditPayment.currency"
                                        v-if="payment.edit"
                                    >
                                        <option value="usd-$">$</option>
                                        <option value="eur-€">€</option>
                                    </select>
                                    <span 
                                        v-if="!payment.edit"
                                        v-text="payment.amount"
                                    ></span>
                                    <input 
                                        v-if="payment.edit"
                                        type="text" 
                                        :value="formEditPayment.amount"
                                        @input="formEditPayment.change($event.target.value)"
                                    >
                                 </div>
                                 <div class="pdbl">
                                    <span 
                                        v-if="!payment.edit"
                                        class="payment_date"
                                        v-text="payment.payment_date"
                                    ></span>
                                    <span 
                                        class="payment_date"
                                        v-text="formEditPayment.date"
                                        v-if="payment.edit"
                                    ></span>                                   
                                    <nav>
                                        <div 
                                            class="flatpickr-edit"
                                            v-show="payment.edit"
                                        >
                                            <input type="text" data-input v-model="formEditPayment.date">      
                                            <a href="javascript:void(0)" data-toggle>
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                                                    <rect x="48" y="80" width="416" height="384" rx="48" ry="48" fill="none" stroke="#000" stroke-linejoin="round" stroke-width="32"/><path d="M397.82 80H114.18C77.69 80 48 110.15 48 147.2V208h16c0-16 16-32 32-32h320c16 0 32 16 32 32h16v-60.8c0-37.05-29.69-67.2-66.18-67.2z"/><circle cx="296" cy="232" r="24"/><circle cx="376" cy="232" r="24"/><circle cx="296" cy="312" r="24"/><circle cx="376" cy="312" r="24"/><circle cx="136" cy="312" r="24"/><circle cx="216" cy="312" r="24"/><circle cx="136" cy="392" r="24"/><circle cx="216" cy="392" r="24"/><circle cx="296" cy="392" r="24"/><path fill="none" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="32" d="M128 48v32M384 48v32"/>
                                                </svg>
                                             </a>
                                        </div>
                                       <a 
                                           href="#" 
                                           @click.prevent="prepareEditData(payment)"
                                           v-if="!payment.edit"
                                       >
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                                                <path fill="none" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="32" d="M364.13 125.25L87 403l-23 45 44.99-23 277.76-277.13-22.62-22.62zM420.69 68.69l-22.62 22.62 22.62 22.63 22.62-22.63a16 16 0 000-22.62h0a16 16 0 00-22.62 0z"/>
                                            </svg>
                                       </a>
                                       <a 
                                           href="#"
                                           :class="{'disabled': payment.disabled}"
                                            @click.prevent="deletePayment(payment)"
                                            v-if="!payment.edit"
                                        >
                                           <svg 
                                                v-if="!payment.preloader"
                                                xmlns="http://www.w3.org/2000/svg" 
                                                viewBox="0 0 512 512"
                                           >
                                                <path d="M112 112l20 320c.95 18.49 14.4 32 32 32h184c17.67 0 30.87-13.51 32-32l20-320" fill="none" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"/><path stroke="#000" stroke-linecap="round" stroke-miterlimit="10" stroke-width="32" d="M80 112h352"/><path d="M192 112V72h0a23.93 23.93 0 0124-24h80a23.93 23.93 0 0124 24h0v40M256 176v224M184 176l8 224M328 176l-8 224" fill="none" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"/>
                                           </svg>
                                           <svg 
                                               v-else
                                               xmlns="http://www.w3.org/2000/svg" 
                                               viewBox="0 0 512 512"
                                               class="animation-rotation">
                                               <path d="M434.67 285.59v-29.8c0-98.73-80.24-178.79-179.2-178.79a179 179 0 00-140.14 67.36m-38.53 82v29.8C76.8 355 157 435 256 435a180.45 180.45 0 00140-66.92" fill="none" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"/>
                                               <path fill="none" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="32" d="M32 256l44-44 46 44M480 256l-44 44-46-44"/>
                                           </svg>
                                       </a>	
                                       <a 
                                            href="#"                                       
                                            @click.prevent="removeEditData(payment)"
                                            v-if="payment.edit"
                                       >
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                                                <path d="M448 256c0-106-86-192-192-192S64 150 64 256s86 192 192 192 192-86 192-192z" fill="none" stroke="#000" stroke-miterlimit="10" stroke-width="32"/><path fill="none" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="32" d="M320 320L192 192M192 320l128-128"/>
                                            </svg>
                                        </a>
                                        <a 
                                            href="#"
                                            v-if="formEditPayment.button && payment.edit"
                                            class="edit"
                                            :class="{'disabled': payment.disabled}"
                                            @click.prevent="editPayment(payment)"
                                        >
                                            <svg 
                                                v-if="!payment.preloader"
                                                xmlns="http://www.w3.org/2000/svg" 
                                                viewBox="0 0 512 512"
                                            >
                                                <path d="M448 256c0-106-86-192-192-192S64 150 64 256s86 192 192 192 192-86 192-192z" fill="none" stroke="#fff" stroke-miterlimit="10" stroke-width="32"/><path fill="none" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width="32" d="M352 176L217.6 336 160 272"/>
                                            </svg>
                                            <svg 
                                                v-else
                                                xmlns="http://www.w3.org/2000/svg" 
                                                viewBox="0 0 512 512"
                                                class="animation-rotation">
                                                <path d="M434.67 285.59v-29.8c0-98.73-80.24-178.79-179.2-178.79a179 179 0 00-140.14 67.36m-38.53 82v29.8C76.8 355 157 435 256 435a180.45 180.45 0 00140-66.92" fill="none" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"/>
                                                <path fill="none" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width="32" d="M32 256l44-44 46 44M480 256l-44 44-46-44"/>
                                            </svg>
                                        </a>	  			
                                     </nav>
                                 </div>
                             </li>
                         </ul>
                     </div>
                 </div>
             </div>
         </section>
    </main>
</template>

<script>
import flatpickr from 'flatpickr'
import 'flatpickr/dist/flatpickr.css'
import { months } from '@/js/storage/months'
import { Helper } from '@/js/utilities/helper'

export default {
	props: ['csrf','main_block_styles','currencies'],
    data(){
        return{
            H: new Helper(), 
            formAddPayment: {
                amount: '',
                button: false,
                currency: 'usd-$',
                date: '',                
                change(v){
                    this.amount = v
                    this.validation()
                },
                validation(){                    
                    this.button = /^\d+$/.test(this.amount) && this.date ? true : false 
                }
            }, 
            formEditPayment:{
                amount: '',
                button: false,
                currency: '',
                date: '',                
                change(v){
                    console.log('this: ',this)   
                    this.amount = v
                    this.validation()
                },
                validation(){                                   
                    this.button = /^\d+$/.test(this.amount) ? true : false 
                }               
            },         
            currencyChecked: {
                eur: false,
                usd: false
            },
            current: {
                usd: {
                    sign: '$',
                    yearSum: 0,
                    active: false
                },
                eur: {
                    sign: '€',
                    yearSum: 0,
                    active: false
                }
            },
            disabled:{
                getYear: false,
                addPayment: false,
                editPayment: false
            },
            paymentsList: [],
            sumByMonth: [],
            sumByMonthPure: [],
            years: []
        }
    },
    methods:{
        test(){},
        prepareEditData(payment){
            payment.edit = true 
            this.formEditPayment.date = payment.payment_date
            this.formEditPayment.currency = payment.currency + '-' + payment.sign  
            this.formEditPayment.amount = payment.amount  
            this.formEditPayment.validation()      
            flatpickr('.flatpickr-edit',{
                wrap: true,
                onChange: function(dateFull,date){
                    this.formEditPayment.date = date                                        
                }.bind(this)
            })  
        },
        removeEditData(payment){
            payment.edit = false
            this.formEditPayment.date = ''
            this.formEditPayment.currency = ''
            this.formEditPayment.amount = ''
            this.formEditPayment.button = false
        },
        recountAndShow(checked,currency,sign){

            this.sumByMonth = JSON.parse( JSON.stringify( this.sumByMonthPure ) )

            Object.keys(this.currencyChecked).forEach(key => {
                this.currencyChecked[key] = false
            })
            this.currencyChecked[currency] = checked ? true : false
            
            if(currency === 'eur' && checked){                  

                    const euroRate = this.currencies[0].sale / this.currencies[1].buy
                    let maxArray = []

                    this.sumByMonth.forEach(item => {
                        const sum = Number( ( item.eur.sum + item.usd.sum * euroRate ).toFixed(0) )
                        item.usd.active = false
                        item.eur.active = true
                        item.eur.sum = this.H.roundTo(sum,10)
                        item.eur.label = this.H.setPointsToNumber(item.eur.sum)  
                        maxArray.push(item.eur.sum)             
                    })
                    const max = Math.max(...maxArray)
                    this.sumByMonth.forEach(item => {
                        item.eur.height =  item.eur.sum * 100  / max  
                        return item          
                    }) 
                    this.thisYearSum('eur')                    
                }else 
                 if(currency === 'usd' && checked){
                    const usdRate = this.currencies[1].sale / this.currencies[0].buy
                    let maxArray = []                   
                    this.sumByMonth.forEach(item => {
                        const sum = Number( ( item.usd.sum + item.eur.sum * usdRate ) ).toFixed(0)
                        item.usd.active = true
                        item.eur.active = false
                        item.usd.sum = this.H.roundTo(sum,10)
                        item.usd.label = this.H.setPointsToNumber(item.usd.sum)  
                        maxArray.push(item.usd.sum)  
                        return item                     
                    })
                    const max = Math.max(...maxArray)
                    this.sumByMonth.forEach(item => {
                        item.usd.height =  item.usd.sum * 100  / max  
                        return item                
                    })
                    this.thisYearSum('usd')     
                }else{
                    this.thisYearSum()     
                } 
        },
        thisYearSum(currency=''){

            this.current.usd.yearSum = 0
            this.current.eur.yearSum = 0
            this.current.usd.active = false
            this.current.eur.active = false

            switch (currency) {
                case 'eur':{
                    this.sumByMonth.forEach(item => {
                        this.current.eur.yearSum += item.eur.sum
                    })
                    this.current.eur.active = true 
                    break;
                }
                case 'usd':{
                    this.sumByMonth.forEach(item => {
                        this.current.usd.yearSum += item.usd.sum
                    })
                    this.current.usd.active = true 
                    break;
                }             
                default:{
                    this.sumByMonth.forEach(item => {
                        this.current.eur.yearSum += item.eur.sum
                        this.current.usd.yearSum += item.usd.sum
                    })
                    this.current.eur.active = true 
                    this.current.usd.active = true 
                    break;
                }
                    
            }

            let eurSum = this.H.roundTo(this.current.eur.yearSum,10)   
            this.current.eur.yearSum = this.H.setPointsToNumber(eurSum)

            let usdSum = this.H.roundTo(this.current.usd.yearSum,10)   
            this.current.usd.yearSum = this.H.setPointsToNumber(usdSum)

        },
        setCurrentYear(currentYearName){
            this.years.forEach(year => year.active = currentYearName === year.name ? true : false)
        },
        showNewData(payment){
            const paymentYear = payment.payment_date.split('-')[0]
            const currentYear = this.years.find(year => year.active)
            if(paymentYear === currentYear.name){
                this.getMonthsData(paymentYear)
            }
        },
        getYears(){
            NProgress.start()
            ajax               
            .get('/payments/years')              
            .then(data =>  {
                    try{
						// console.log('data: ',data) 
                        const parsed = JSON.parse(data)
                        // console.log('parsed: ',parsed) 
                        this.years = parsed.map(year => {
                            return { 
                                name: year,
                                active: false
                             }
                        })
                        this.years[0].active = true
                        this.getMonthsData(this.years[0].name)
                        this.getPaymentsByYear(this.years[0].name)
                        NProgress.done()
                    }catch(e){
                        this.years = []
                        console.log('PARSING DATA ERROR: ',e.message)
                        alert('ERROR: SEE CONSOLE')
                    }
                    
                },             
                err => {
                    console.log('err: ',err)  
                    alert('ERROR: SEE CONSOLE')
                }           
              )  
        },
        getMonthsData(year){
            this.disabled.getYear = true
            Object.keys(this.currencyChecked).forEach(key => this.currencyChecked[key] = false)
            const data = { year }
            ajax               
            .get('/payments/months-data',data)              
            .then(data =>  {
                    try{
                        // console.log('data: ',data)                        
                        const parsed = JSON.parse(data) 
                        // console.log('parsed: ',parsed)                       
                        let max = parsed.sum_by_month.reduce((acc,cur) => {
                            acc.push(cur.usd)
                            acc.push(cur.eur)
                            return acc
                        }, [] )
                        max = Math.max(...max)
                        this.sumByMonth = parsed.sum_by_month.map( (month,i) => {
                            return {
                                name: months[i].name.en,
                                usd: {
                                    label: this.H.setPointsToNumber(month.usd),
                                    sum: Number(month.usd),
                                    height: month.usd * 100  / max,
                                    active: true
                                },
                                eur: {
                                    label: this.H.setPointsToNumber(month.eur),
                                    sum: Number(month.eur),
                                    height: month.eur * 100  / max,
                                    active: true
                                }
                            }
                        })   

                        this.sumByMonthPure = JSON.parse( JSON.stringify(this.sumByMonth) )
                        this.thisYearSum()
                        this.setCurrentYear(year)

                    }catch(e){
                        this.sumByMonth = []                        
                        console.log('PARSING DATA ERROR: ',e.message)
                        alert('ERROR: SEE CONSOLE')
                    }finally{
                        this.disabled.getYear = false
                    }                   
                },             
                err => {
                    this.disabled.getYear = false
                    console.log('err: ',err)  
                    alert('ERROR: SEE CONSOLE')
                }           
              ) 
        },
        getPaymentsByYear(year){
            const data = { year }
            ajax               
            .get('/payments/by-year',data)              
            .then(data =>  {
                    try{
                        // console.log('data: ',data)                        
                        const parsed = JSON.parse(data) 
                        // console.log('parsed: ',parsed)                       
                        this.paymentsList = parsed.payments_data.map(payment => {
                            payment.disabled = false
                            payment.preloader = false
                            payment.edit = false
                            return payment
                        })

                    }catch(e){
                        this.paymentsList = []
                        console.log('PARSING DATA ERROR: ',e.message)
                        alert('ERROR: SEE CONSOLE')
                    }                  
                },             
                err => {
                    console.log('err: ',err)  
                    alert('ERROR: SEE CONSOLE')
                }           
              )             
        },
        addPayment(){
            const payment = {
                amount: this.formAddPayment.amount,
                payment_date: this.formAddPayment.date,
                sign: this.formAddPayment.currency.split('-')[1],
                currency: this.formAddPayment.currency.split('-')[0]
            }

            this.disabled.addPayment = true

    	 	ajax.post('/payment/add',payment,this.csrf)              
	            .then(data =>  {
	            		// console.log('data: ',data)
	            		try{
	            			const parsed = JSON.parse(data)
	            			// console.log('parsed: ',parsed)
	            			if(parsed.status){
                                payment.id = parsed.id
                                payment.disabled = false
                                payment.preloader = false
                                payment.edit = false
                                this.paymentsList.unshift(payment)

                                this.showNewData(payment)

                                this.formAddPayment.button = false
                                this.formAddPayment.date = ''
                                this.formAddPayment.amount = ''
                                this.formAddPayment.currency = 'usd-$'
	            			}	            			
	            		}catch(e){
	            			console.log('PARSING DATA ERROR: ',e.message)
                            alert('ERROR: SEE CONSOLE')
	            		}finally{
	            			this.disabled.addPayment = false
	            		}
	                },             
	                err => {
	                	this.disabled.addPayment = false
                        console.log('err: ',err)
                        alert('ERROR: SEE CONSOLE')
	                }           
	              )             

        },
        editPayment(payment){
            payment.preloader = true
            payment.disabled = true
            const dts = {
                id: payment.id,
                amount: this.formEditPayment.amount,
                sign: this.formEditPayment.currency.split('-')[1],
                currency: this.formEditPayment.currency.split('-')[0],
                payment_date: this.formEditPayment.date
            }
            ajax.put('/payment/update',dts,this.csrf)              
	            .then(data =>  {
	            		// console.log('data: ',data)
	            		try{
	            			const parsed = JSON.parse(data)
	            			if(parsed.status){
	            				// console.log('parsed: ',parsed)
					            this.paymentsList.forEach((payment,i)=>{
					                if(payment.id === dts.id){
                                        Object.keys(dts).forEach(key => this.paymentsList[i][key] = dts[key] )
					                }               
                                }) 
                                this.showNewData(payment) 
								this.removeEditData(payment)
	            			}	            			
	            		}catch(e){
                            console.log('PARSING DATA ERROR: ',e.message)
                            alert('ERROR: SEE CONSOLE')
	            		}finally{
                            payment.preloader = false
                            payment.disabled = false
	            		}
	            		
	                },             
	                err => {
                        payment.preloader = false
                        payment.disabled = false
                        console.log('err: ',err)  
                        alert('ERROR: SEE CONSOLE')
	                }           
	              )  
        },
        deletePayment(payment){
            console.log('payment: ',payment)
            payment.preloader = true
    	 	payment.disabled = true          
            const ID = payment.id
    	 	ajax.delete('/payment/delete',ID,this.csrf)              
	            .then(data =>  {
	            		// console.log('data: ',data)
	            		try{
	            			const parsed = JSON.parse(data)
	            			if(parsed.status){
					            const index = this.paymentsList.findIndex( payment => payment.id === ID )   
                                this.paymentsList.splice(index,1) 
                                this.showNewData(payment) 	            				
	            			}	            			
	            		}catch(e){
                            console.log('PARSING DATA ERROR: ',e.message)
                            alert('ERROR: SEE CONSOLE')
	            		}finally{
                            payment.preloader = false
                            payment.disabled = false
	            		}
	            		
	                },             
	                err => {
                        payment.preloader = false
                        payment.disabled = false
                        console.log('err: ',err)   
                        alert('ERROR: SEE CONSOLE')
	                }           
	              )     	 	
		 }
    },
    mounted(){
        flatpickr('.flatpickr',{
            wrap: true,
            onChange: function(dateFull,date){
                this.formAddPayment.date = date
                this.formAddPayment.validation()
            }.bind(this)
        })

        this.getYears()
    }
};
</script>
